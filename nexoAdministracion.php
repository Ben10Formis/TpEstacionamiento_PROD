<?phprequire_once ("clases/accesoDatos.php");require_once("clases/auto.php");require_once("clases/factura.php");require_once("clases/usuario.php");date_default_timezone_set('America/Argentina/Buenos_Aires');$queHago = isset($_POST['queHacer']) ? $_POST['queHacer'] : NULL;//interactua con las funciones jsonswitch($queHago){	case 'iniciar':		//alert("INICIANDO APLICACION");		//mailUsrAux vienen de gestion de usuario		//mailUsr		//Cuando quiere ser recordada el usuario		setcookie("mailtipoAux", "INI" , time() + (86400 * 30), "/"); //http://php.net/manual/es/function.setcookie.php		if(isset($_COOKIE["mailUsr"])){ //Esta inicializada la cookie y quiere ser recordado el usuario			echo htmlspecialchars($_COOKIE["mailUsr"]); //Ciertos caracteres tienen significados especiales en HTML, y deben ser representados por entidades HTML si se desea preservar su significado. https://es.functions-online.com/htmlspecialchars.html		}		else{			//echo "NO-LOGEADO"; //no me funciona no se por que			echo false;		}	break;	case "mostrarAltaEstacionado":			if(estaLogeado()){				//include("partes/formAltaEstacionado.php");				$vformAltaEstacionado = '					<form method="post" id="frmAltaEstacionado">					<h1 >Ingrese Patente</h1>					<div class="inset">					<p>					<input type="text" id="patente" name="patente" minlength="6" placeholder="Patente" required>					</p>					<table style="border-collapse: separate; border-spacing: 10px;">					<tr>					<td>					<input class="btn btn-lg btn-primary btn-block" type="button" value="Ingresar Patente" onclick="return validarFormatoPatente()">					</td>					</tr>					</table>					</div>					</form>				';				echo $vformAltaEstacionado;							}else{				//echo "NO-LOGEADO"; 				echo false;			}	break;	case "mostrarLogin":		 	//include("frmLoginEst.php");			$vfrmLoginEst = '				<form method="post" id="frmIngreso">				<h1 >INGRESE SUS DATOS</h1>				<div class="inset">				<p>				<label for="email">MAIL</label>				<input type="email" placeholder="Correo electronico" name="mail" id="mail" required>				</p>				<p>				<label for="password">CLAVE</label>				<input minlength="4" type="password" name="clave" id="clave" placeholder="Ingrese Clave" required>				</p>				<p>				<input type="checkbox" name="remember" id="remember"> 				<label for="remember">Recordarme</label> 				</p>				<table style="border-collapse: separate; border-spacing: 10px;">				<tr>				<td>				<input type="submit" name="go" value="Test Admin" onclick="llenarAdmin();return false;">				</td>				<td><input type="submit" name="go" value="Test Usuario" onclick="llenarUsuario();return false;"></td>				</tr>				<tr>				<td>				<input type="submit" id="botonIngresar" name="go" value="Ingresar" onclick="return ejecutarAccion(0);"> 				</td>				<td><input type="submit" name="go" value="Registrar" onclick="return ejecutarAccion(1);" ></td>				</tr>				</table>				</div>				</form>			';			echo $vfrmLoginEst;	break;	case "mostrarGrillaEstacionados":		if(estaLogeado()){			desplegarGrillaAutosEstacionados();		}		else{			//echo "NO-LOGEADO"; 			echo false;		}		break;	case "mostrarGrillaImportes":		if(estaHabilitado()){			mostrarGrillaImportes();		}		else{			//echo "NO-ADMIN";			echo false;		}		break;	case "mostrarGrillaUsuarios":		if(estaHabilitado()){ 			desplegarGrillaUsuarios();		} 		else{			//echo "NO-ADMIN";			echo false;		}	break;	case "deslogear":		setcookie("mailUsr", "" , time() , "/");		setcookie("mailUsrAux", "" , time() , "/");	break;	case 'guardarAuto':		$auto = new auto();		$auto->patente=$_POST['patente'];		$ahora= getdate();		$auto->ingreso = $ahora["year"]."-".$ahora["mon"]."-".$ahora["mday"]."-".$ahora["hours"]."-".$ahora["minutes"];		$cantidad=$auto->InsertarElAuto();		echo json_encode($cantidad);			break;	case 'eliminarAuto':		eliminarAuto();	break;	case 'eliminarFactura':		eliminarFactura();	break;	case "mostrarInforme":		if(estaHabilitado()){			mostrarInforme();		}		else{			//echo "NO-ADMIN";			echo false;		}		break;	default:		echo ":( cuando no entro en case de nexoadministrador";}//Funcion internafunction estaLogeado(){	return $_COOKIE["mailtipoAux"] != "INI" || isset($_COOKIE["mailUsr"]);}function estaHabilitado(){	if (isset($_COOKIE["mailtipoAux"]) && $_COOKIE["mailtipoAux"] == "admin") 	{		return true;	}	if( isset($_COOKIE["mailtipo"]) && $_COOKIE["mailtipo"] == "admin"){	 	return true;	}	return false ;}function desplegarGrillaAutosEstacionados(){	$AutosRecuperados = auto::TraerTodosLosAutos();		$grilla = '<table class="miTablaUsuarios" BORDER=6 bordercolor="#23527c" width="75%">					<thead style="background:rgb(0, 0, 0);color:#fff;">						<th colspan="3" >&nbsp;&nbsp;&nbsp;AUTOS ESTACIONADOS</th>							<tr>								<th >  PATENTE     </th>								<th colspan="2">  FECHA INGRESO  </th>							</tr> 					</thead>';   			foreach ($AutosRecuperados as $aut){			$auto = array();			$auto["id"] = $aut->id;			$auto["patente"] = $aut->patente;			$auto["ingreso"] = $aut->ingreso;			$auto = json_encode($auto);						$fecAmostrar=explode("-",$aut->ingreso);			$fecAmostrarFor = $fecAmostrar[3].":".$fecAmostrar[4]." ".$fecAmostrar[2]."-".$fecAmostrar[1]."-".$fecAmostrar[0];			//$fecAmostrarFor =$aut->ingreso;			$grilla .= "<tbody style='background-color:#2a589e'><tr>							<td>".$aut->patente."</td>							<td>".$fecAmostrarFor."</td>							<td><input type='button' value='Retirar' class='MiBotonUTN' id='btnEliminar' onclick='eliminarAuto($auto)' /></td>						</tr></tbody>";		}				$grilla .= '</table>';						echo $grilla;}function mostrarGrillaImportes(){	$FacturasRecuperadas = factura::TraerTodasLasFacturas();		$grilla = '<table class="miTablaUsuarios" BORDER=6  bordercolor="#23527c" width="100%">					<thead style="background:rgb(0, 0, 0);color:#fff;">					<th colspan="5">LISTA FACTURAS</th>						<tr>							<th>  PATENTE     </th>							<th>  FECHA INGRESO  </th>							<th>  FECHA EGRESO  </th>							<th>  FACTURADO  </th>							<th>  </th>						</tr> 					</thead>';   			foreach ($FacturasRecuperadas as $fact){			$factura = array();			$factura["id"] = $fact->id;			$factura["patente"] = $fact->patente;			$factura["ingreso"] = $fact->ingreso;			$factura["egreso"] = $fact->egreso;			$factura["monto"] = $fact->monto;			$factura = json_encode($factura);			$fecAmostrarIng=explode("-",$fact->ingreso);			$fecAmostrarForIng = $fecAmostrarIng[3].":".$fecAmostrarIng[4]." ".$fecAmostrarIng[2]."-".$fecAmostrarIng[1]."-".$fecAmostrarIng[0];			$fecAmostrarEg=explode("-",$fact->egreso);			$fecAmostrarForEg = $fecAmostrarEg[3].":".$fecAmostrarEg[4]." ".$fecAmostrarEg[2]."-".$fecAmostrarEg[1]."-".$fecAmostrarEg[0];			$grilla .= "<tbody style='background-color:#2a589e'><tr>							<td>".$fact->patente."</td>							<td>".$fecAmostrarForIng."</td>							<td>".$fecAmostrarForEg."</td>							<td> $ ".$fact->monto."</td>				<td><input type='button' value='Sacar' class='MiBotonUTN'  onclick='eliminarFactura($factura)'/></td>				</tr></tbody>";		}				$grilla .= '</table>';						echo $grilla;	}function desplegarGrillaUsuarios(){	$ArrayDeUsuarios = usuario::TraerTodoLosUsuarios();		/*$grilla = '<table class="miTablaUsuarios" BORDER=6>					<thead style="background:rgb(0, 0, 0);color:#fff;">						<tr>							<th>  LISTA DE USUARIOS  </th>						</tr> 					</thead>';   */		$grilla = '<table class="miTablaUsuarios" BORDER=6  bordercolor="#23527c" width="75%">					<thead style="background:rgb(0, 0, 0);color:#fff;">					<th colspan="5">LISTA USUARIOS</th>						<tr>							<th>  MAIL     </th>							<th>  TIPO  </th>						</tr> 					</thead>';  			foreach ($ArrayDeUsuarios as $user){			$usuario = array();			$usuario["mail"] = $user->mail;			$usuario["clave"] = $user->clave;			$usuario["tipo"] = $user->tipo;					$grilla .= "<tbody style='background-color:#2a589e'><tr>				<td>".$user->mail."</td>				<td>".$user->tipo."</td>			</tr></tbody>";		}				$grilla .= '</table>';						echo $grilla;}function eliminarAuto(){		$retorno["Exito"] = TRUE;	$retorno["Mensaje"] = "";	$autoAborrar = isset($_POST['auto']) ? json_decode(json_encode($_POST['auto'])) : NULL;    	if ($autoAborrar != NULL){				$factAgregada=agregarFactura($autoAborrar->patente , $autoAborrar->ingreso);		if($factAgregada != false && $factAgregada!= NULL){			if(!auto::BorrarAuto($autoAborrar->id)){				$retorno["Exito"] = FALSE;				$retorno["Mensaje"] = "Ocurrio un error y no se pudo borrar el auto.";			}			else{				$retorno["Mensaje"] = "El auto fue retirado correctamente. Monto a pagar = ".$factAgregada->monto ;			}		}else{			$retorno["Mensaje"] = "ERROR EN PROCESO DE FACTURACION";		}	}else{		$retorno["Mensaje"] = "EL AUTO VINO VACIO";	}	echo json_encode($retorno);}function agregarFactura($patente, $ingreso){	$facturaNueva = factura::iniNuevaFactura($patente,$ingreso);	$fact = $facturaNueva->InsertarFactura();	return $fact;}function eliminarFactura(){		$retorno["Exito"] = TRUE;	$retorno["Mensaje"] = "";	$factura = isset($_POST['factura']) ? json_decode(json_encode($_POST['factura'])) : NULL;	if(isset($factura) && $factura != NULL){		if(!factura::BorrarFactura($factura->id)){		$retorno["Exito"] = FALSE;		$retorno["Mensaje"] = "Ocurrio un error y no se pudo borrar la factura.";		}else{			$retorno["Mensaje"] = "Factura borrada correctamente." ;		}	}else{		$retorno["Mensaje"] = "Error al borrar factura." ;	}	echo json_encode($retorno);}function mostrarInforme(){	$FacturasRecuperadas = factura::VentaTotalPorDia();		$grilla = '<table class="miTablaUsuarios" BORDER=6  bordercolor="#23527c" width="50%">					<thead style="background:rgb(0, 0, 0);color:#fff;">					<th colspan="2">INFORME DE FACTURACION</th>						<tr>							<th>  PERIODO     </th>							<th>  TOTAL </th>						</tr> 					</thead>';   			foreach ($FacturasRecuperadas as $fact){			$factura = array();			$factura = json_encode($factura);			$grilla .= "<tbody style='background-color:#2a589e'><tr>							<td>".$fact->fecha."</td>							<td> $".$fact->total."</td>				</tr></tbody>";		}				$grilla .= '</table>';						echo $grilla;	}?>